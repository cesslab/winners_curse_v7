{% extends "global/Page.html" %}
{% load otree static %}

{% block styles %}
<link rel="stylesheet" href="{% static 'global/css/bid.css' %}">
<link rel="stylesheet" href="{% static 'global/css/multi_step_progress_bar.css' %}">

<link rel="stylesheet" href="{% static 'global/css/round_navbar.css' %}">
<link rel="stylesheet" href="{% static 'global/css/lottery_navbar.css' %}">

<link href='https://fonts.googleapis.com/css?family=Palanquin:500' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="{% static 'global/css/font-awesome.css' %}">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/3.4.0/introjs.css" integrity="sha512-i+WzzATeaDcwcfi5CfLn63qBxrKqiQvDLC+IChU1zVlaPguPgJlddOR07nU28XOoIOno9WPmJ+3ccUInpmHxBg==" crossorigin="anonymous" />
<link rel="stylesheet" href="{% static 'global/css/tooltip.css' %}">
{% endblock %}

  {% block content %}
  {% include 'global/LotteryRoundNavbar.html' %}
  <div class="grid-container">
    <div>
      <div class="lottery-header">
        <h4 class="text-center"><u>Lottery of type {{ player.lottery_order }}</u></h4>
      </div>
      <div>
        <p>Consider the following lottery ticket with two possible prizes,
          0 and a value v.</p>
      </div>
      <div class="lottery">
        <p class="text-center">
          {% if player.is_value_treatment %}
          With a probability of {{ player.ticket_probability }}% you get<br>
          a value v between {{ player.alpha }} and {{ player.beta }} credits,<br>
          otherwise you get 0 credits.
          {% else %}
          With a probability p between {{ player.alpha }}% and {{ player.beta }}%, you get<br>
          a value v = {{ player.fixed_value }} credits,<br>
          otherwise you get 0 credits.
          {% endif %}
        </p>
      </div>

      <div>
        <h4 class="text-center lottery-header"><u>Your Signal</u></h4>
        <p class="text-center">
          {% if player.is_value_treatment %}
          Your signal about v is: {{ player.signal }}
          {% else %}
          Your signal about p is: {{ player.signal }}%
          {% endif %} (with x = {{ player.epsilon }}).
        </p>
      </div>

      <div>
        <h5 class=""><u>Signal Interpretation</u></h5>
        <p>
          {% if player.is_value_treatment %}
          The Selected Value v is at most {{ player.epsilon }} units away from your signal about v.
          Given your signal, the Selected Value must lie between {{ player.min_signal }} and {{ player.max_signal }}.
          {% else %}
          The Selected Probability p is at most {{ player.epsilon }} percentage points away from your signal about p.
          <br>
        Given your signal, the Selected Probability must lie between {{ player.min_signal }}% and {{ player.max_signal }}%.
        {% endif %}
        </p>
      </div>
      {% next_button %}
  </div>
  <div>
    <div>
      <ul class="list-unstyled multi-steps">
        <li>Question 1</li>
        <li class="is-active">Question 2</li>
        <li>Question 3</li>
      </ul>
    </div>
    <div id="task">
      <div id="question">
        <h5>What is the probability that your signal is the highest one in the auction?</h5>
      </div>
      <div>
        <input type="number" id="id_probability_highest_signal" name="probability_highest_signal" min="0" max="100" step="1"
               class="center-input form-control" value="{{ form.probability_highest_signal.object_data }}"
               placeholder="Enter a number between 0 and 100"
               data-for="bid-selected-probability" required>

        {% if form.probability_highest_signal.errors %}
        <div class="alert alert-danger">
          {{ form.probability_highest_signal.errors }}
        </div>
        {% endif %}
      </div>

    </div>
  </div>
</div>



<div class="modal" id="modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Notification</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Your willingness to pay is larger than the highest possible outcome of the lottery.</p>
        <p>Please submit a reasonable willingness to pay that does not exceed the highest possible outcome of the
          lottery.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="modal-btn btn btn-secondary" data-dismiss="modal">Back</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  displayMappedValue(document.getElementById("id_min_worth"));
  displayMappedValue(document.getElementById("id_bid"));
  displayMappedValue(document.getElementById("id_max_worth"));

  document.getElementById("id_min_worth").addEventListener("keyup", (event) => {
    displayMappedValue(event.target);
  })
  document.getElementById("id_bid").addEventListener("keyup", (event) => {
    displayMappedValue(event.target);
  })
  document.getElementById("id_max_worth").addEventListener("keyup", (event) => {
    displayMappedValue(event.target);
  })

  document.getElementById('id_bid').addEventListener("keyup", (event) => {
    bidChecker(event.target);
  });

  function isInteger(valStr) {
    return !isNaN(valStr) && Number.isInteger(parseFloat(valStr));
  }

  function displayMappedValue(element) {
    var correspondingElement = document.getElementById(element.dataset.for);

    var worth = parseInt(element.value);
    if (!isInteger(worth)) {
      correspondingElement.textContent = "";
      return;
    }

    var suffix = (js_vars.is_probability_treatment) ? "%" : "";
    correspondingElement.textContent = parseInt((worth / js_vars.mapping_divisor) * 100) + suffix;
  }

  function bidChecker(element) {
    var max = js_vars.lottery_max_value;
    if (element.value > max) {
      $('#modal').modal('show');
    }
  }

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/3.4.0/intro.min.js" integrity="sha512-QWPjvFqgUJv5X6Sq5NXmwJQSEzUEBxmCCcgqJd5/5luZnS6llRbshsChUNKrFlZ4bshKZEJxAHDB+WWdMsGvUA==" crossorigin="anonymous"></script>
<script type="text/javascript">
  IMG_URL = '{% static "global/img/q2_graph.png" %}';
</script>
<script>
  if (js_vars.display_intro) {
    introJs().setOptions({
      steps: [
        {
          title: 'Your Task',
          intro: '<div><p>Choose a number between 0% and 100%. You increase your chance of getting 12 credits, 1) the closer your ' +
            'number is to 100% and your signal is indeed the highest one, or 2) the closer your number is to 0% and your ' +
            'signal is NOT the highest one. The best you can do is to report your true belief about the probability.</p></div>' +
            '<div><img src="' + IMG_URL + '" alt="graph"></div>' +
            '<div><p>The computer will randomly draw a number between 0 and 1 (where all numbers have equal chances of ' +
            'being drawn). If the squared difference betweenthetruth(0% or 100%)andyourguess,(truth - your guess)^2, is ' +
            'smaller than the random number, you will get 12 credits; if not, you will get nothing.</p></div>',
          position: 'top',
          element: document.querySelector(('#task'))
        },
      ]
    }).start()

  }
</script>
{% endblock %}
